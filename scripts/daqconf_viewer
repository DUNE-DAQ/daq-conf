#!/usr/bin/env python3
import asyncio
import httpx
import json
import sys

#from json_diff import Comparator
from rich.text import Text

from textual import log, events
from textual.app import App, ComposeResult
from textual.containers import Horizontal, Content, Container, Vertical
from textual.widget import Widget
from textual.widgets import Button, Header, Footer, Static, Input, Label, ListView, ListItem, Tree
from textual.reactive import reactive, Reactive
from textual.message import Message, MessageTarget
from textual.screen import Screen

auth = ("fooUsr", "barPass")

class LabelItem(ListItem):
    def __init__(self, label: str) -> None:
        super().__init__()
        self.label = label

    def compose( self ) -> ComposeResult:
        yield Label(self.label)

class Configs(Static):
    conflist = reactive([])

    def __init__(self, hostname, **kwargs):
        super().__init__(**kwargs)
        self.hostname = hostname

    def on_mount(self) -> None:
        self.set_interval(0.1, self.update_configs)

    def compose(self) -> ComposeResult:
       yield ListView(LabelItem("asfas"))

    async def update_configs(self) -> None:
        async with httpx.AsyncClient() as client:
            r = await client.get(f'{self.hostname}/listConfigs', auth=auth, timeout=60)
        unsorted = r.json()['configs']
        self.conflist = sorted(unsorted, key=str.lower)

    def watch_conflist(self, conflist:list[str]):
        label_list = [LabelItem(c) for c in conflist]
        the_list = self.query_one(ListView)
        the_list.clear()
        for item in label_list:
            the_list.append(item)

    def on_list_view_selected(self, event: ListView.Selected):
        '''The query gets all children of the app, then we choose Versions.'''
        confname = event.item.label
        versions = self.app.query_one(Horizontal)
        versions.new_conf(confname)

class Versions(Horizontal):
    vlist = reactive([])

    def __init__(self, hostname, **kwargs):
        super().__init__(**kwargs)
        self.hostname = hostname
        self.current_conf = None

    def on_mount(self) -> None:
        self.set_interval(0.1, self.update_versions)

    def new_conf(self, conf) -> None:
        self.current_conf = conf

    async def update_versions(self) -> None:
        if self.current_conf:
            async with httpx.AsyncClient() as client:
                payload = {'name': self.current_conf}
                r = await client.get(f'{self.hostname}/listVersions', auth=auth, params=payload, timeout=60)
            self.vlist = r.json()['versions']            #This is a list of ints

    def watch_vlist(self, vlist:list[int]) -> None:
        old_buttons = self.query(Button)
        for b in old_buttons:
           b.remove()
        for v in vlist:
            b_id = 'v' + str(v)    #An id can't be just a number for some reason
            self.mount(Button(str(v), id=b_id, classes='vbuttons', variant='primary'))

    #TODO make buttons smaller, and force them to be in the centre (current position is a coincidence due to the margin)
    async def on_button_pressed (self, event: Button.Pressed) -> None:
        button_id = event.button.id
        version = int(button_id[1:])
        for v in self.app.query(Vertical):
            if isinstance(v, Display):
                await v.get_json(self.current_conf, version)
                break

class Display(Vertical):
    confdata = reactive(None)

    def __init__(self, hostname, **kwargs):
        super().__init__(**kwargs)
        self.hostname = hostname
        self.confname = None
        self.version = None 

    def compose(self) -> ComposeResult:
       yield Tree("Root", id='conftree')
       yield Container(Button("Get Diff", id='diff_btn', variant='primary'))

    async def get_json(self, conf, ver) -> None:
        self.confname = conf
        self.version = ver
        if self.confname != None and self.version != None:
            async with httpx.AsyncClient() as client:
                payload = {'name': self.confname, 'version': self.version}
                r = await client.get(f'{self.hostname}/retrieveVersion', auth=auth, params=payload, timeout=60)
            self.confdata = r.json()

    def json_into_tree(cls, node, json_data):
        """Takes a JSON, and puts it into the tree."""
        from rich.highlighter import ReprHighlighter

        highlighter = ReprHighlighter()

        def add_node(name, node, data) -> None:
            """Adds a node to the tree.
            Args:
                name (str): Name of the node.
                node (TreeNode): Parent node.
                data (object): Data associated with the node.
            """
            if isinstance(data, dict):
                node.set_label(Text(f"{{}} {name}"))
                for key, value in data.items():
                    new_node = node.add("")
                    add_node(key, new_node, value)
            elif isinstance(data, list):
                node.set_label(Text(f"[] {name}"))
                for index, value in enumerate(data):
                    new_node = node.add("")
                    add_node(str(index), new_node, value)
            else:
                node.allow_expand = False
                if name:
                    label = Text.assemble(
                        Text.from_markup(f"[b]{name}[/b]="), highlighter(repr(data))
                    )
                else:
                    label = Text(repr(data))
                node.set_label(label)

        add_node("", node, json_data)

    def watch_confdata(self, confdata:dict) -> None:
        tree = self.query_one(Tree)
        tree.clear()
        self.json_into_tree(tree.root, confdata)
        tree.root.expand()

    def on_button_pressed(self) -> None:
        app.push_screen(DiffScreen())

class DiffScreen(Screen):
    pass

class ConfViewer(App):
    CSS_PATH = "daqconf_viewer.css"
    #For some reason, importing json_diff makes these two modules start printing to stdout when a HTTP request is sent.
    #The following code supresses all non-critical messages (hopefully all of them).
    import logging
    logging.getLogger('asyncio').setLevel(logging.CRITICAL)
    logging.getLogger('httpx').setLevel(logging.CRITICAL)

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.hostname = "http://np04-srv-023:31011"

    def compose(self) -> ComposeResult:
        """Create child widgets for the app."""
        yield Configs(hostname=self.hostname, classes='container', id='configs')
        yield Versions(hostname=self.hostname, classes='container', id='versions')
        yield Display(hostname=self.hostname, classes='container', id='display')

        yield Header(show_clock=True)
        yield Footer()

if __name__ == "__main__":
    app = ConfViewer()
    app.run()
